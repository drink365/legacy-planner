# pages/02_Tax_Path_Simulator.py
from __future__ import annotations
import re
from typing import Dict, Any, Tuple

import streamlit as st
import pandas as pd

from components.lead_capture_and_pdf import lead_capture_and_pdf
from src.tax.tw_estate import calculate_estate_tax_2025  # ä¾ç…§ä½ å‰›æ–°å¢çš„æ¨¡çµ„

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åŸºæœ¬è¨­å®š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ğŸ§­ å‚³æ‰¿è·¯å¾‘æ¨¡æ“¬", page_icon="ğŸ§­", layout="wide")
st.title("ğŸ§­ å‚³æ‰¿è·¯å¾‘æ¨¡æ“¬ï¼ˆé¡§å•å¼é«”é©—ï¼‰")
st.caption("èªªæ˜ï¼šæœ¬é ç‚ºæ•™è‚²ç¤ºæ„ï¼›ç¨…é¡æ¡ 2025 å¹´æ­£å¼ä¸‰ç´šè·ç´¯é€²èˆ‡æ‰£é™¤é‚è¼¯ï¼Œå¯¦å‹™ä»éœ€ç”±é¡§å•å¯©è¦–èˆ‡èª¿æ•´ã€‚")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å°å·¥å…·
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def sanitize_plus(s: str) -> str:
    """å°‡ã€é…å¶ï¼‹äºŒå­å¥³ã€ç­‰ +/ï¼‹ æ”¹æˆé “è™Ÿï¼Œé¿å…èª¤è®€"""
    return re.sub(r"[+ï¼‹]", "ã€", s)

def derive_kpi(comparisons: Dict[str, Dict[str, Any]]) -> Tuple[str, int, int, str]:
    """å¾æƒ…å¢ƒæ¯”è¼ƒæ¨ KPIï¼šæœ€ä½³æ–¹æ¡ˆ / ç¯€çœé‡‘é¡ / åŸºæº–ç¨…é¡ / é™å¹…%"""
    # æ‰¾ baseline
    base_key = None
    for k in comparisons:
        if "ä¸è¦åŠƒ" in k or "åŸºæº–" in k:
            base_key = k
            break
    if base_key is None:
        base_key = max(comparisons, key=lambda x: comparisons[x].get("total_tax", 0))

    base_tax = int(comparisons[base_key].get("total_tax", 0))
    # æ‰¾æœ€ä½
    best_key = min(comparisons, key=lambda x: comparisons[x].get("total_tax", 10**9))
    best_tax = int(comparisons[best_key].get("total_tax", 0))
    saved = max(base_tax - best_tax, 0)
    pct = f"{round(saved / base_tax * 100)}%" if base_tax > 0 else "-"
    return best_key, saved, base_tax, pct

def liquidity_gap(tax_need_10k: int, cash_10k: int) -> Tuple[int, str]:
    """æµå‹•æ€§ç¼ºå£ï¼ˆéœ€è¦ç¨…æº - ç¾é‡‘ï¼‰ï¼Œ<0 è¡¨è¶³é¡"""
    gap = tax_need_10k - cash_10k
    if gap <= 0:
        return 0, "ç¾é‡‘è¶³ä»¥è¦†è“‹ç¨…æ¬¾"
    return gap, f"ç¾é‡‘ä¸è¶³ {gap} è¬ï¼Œå»ºè­°è¦åŠƒç¨…æºæ± ï¼ˆä¿å–®/ä¿¡è¨—ï¼‰"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# è¡¨å–®ï¼šå®¶åº­èˆ‡è³‡ç”¢
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
with st.form("qna_form"):
    st.subheader("Step 1ï½œå®¶åº­èˆ‡åå¥½")
    c1, c2, c3 = st.columns(3)
    with c1:
        members = st.multiselect(
            "å®¶åº­æˆå“¡",
            ["é…å¶", "é•·å­", "æ¬¡å­", "é•·å¥³", "æ¬¡å¥³", "çˆ¶æ¯", "å…¶ä»–"],
            default=["é…å¶", "é•·å­", "æ¬¡å¥³"],
        )
    with c2:
        overseas = st.selectbox(
            "æ˜¯å¦æœ‰æµ·å¤–è³‡ç”¢",
            ["ç„¡", "æœ‰ï¼ˆä¸­åœ‹ï¼‰", "æœ‰ï¼ˆæ—¥æœ¬ï¼‰", "æœ‰ï¼ˆæ–°åŠ å¡ï¼‰", "æœ‰ï¼ˆè¶Šå—ï¼‰", "æœ‰ï¼ˆå…¶ä»–ï¼‰"],
            index=0,
        )
    with c3:
        prefer = st.radio("è¦åŠƒåå¥½", ["ç¶­æŒç¶“ç‡Ÿæ§åˆ¶", "é™ä½å®¶æ—çˆ­è­°", "ç¯€ç¨…å„ªå…ˆ"], index=1, horizontal=True)

    st.subheader("Step 1.1ï½œå®¶åº­äººæ•¸ç´°é …ï¼ˆå½±éŸ¿æ‰£é™¤é¡ï¼‰")
    f1, f2, f3, f4, f5 = st.columns(5)
    with f1:
        has_spouse = st.checkbox("æœ‰é…å¶", value=True)
    with f2:
        adult_children = st.number_input("æˆå¹´å­å¥³æ•¸", min_value=0, max_value=10, value=2, step=1)
    with f3:
        parents = st.number_input("çˆ¶æ¯äººæ•¸ï¼ˆæœ€å¤š2ï¼‰", min_value=0, max_value=2, value=0, step=1)
    with f4:
        disabled_people = st.number_input("é‡åº¦èº«å¿ƒéšœç¤™è€…æ•¸", min_value=0, max_value=5, value=0, step=1)
    with f5:
        other_dependents = st.number_input("å…¶ä»–å—æ‰¶é¤Šï¼ˆå…„å¼Ÿå§Šå¦¹/ç¥–çˆ¶æ¯ï¼‰", min_value=0, max_value=5, value=0, step=1)

    st.subheader("Step 2ï½œè³‡ç”¢æ¦‚æ³ï¼ˆæ–°å°å¹£ï¼Œè¬å…ƒï¼‰")
    a1, a2, a3 = st.columns(3)
    with a1:
        realty = st.number_input("ä¸å‹•ç”¢", min_value=0, value=6000, step=100)
    with a2:
        equities = st.number_input("è‚¡ç¥¨/åŸºé‡‘", min_value=0, value=2000, step=100)
    with a3:
        cash = st.number_input("ç¾é‡‘/å­˜æ¬¾", min_value=0, value=1000, step=50)

    st.subheader("Step 3ï½œæƒ³ç•™çµ¦èª°ï¼Ÿï¼ˆæ–‡å­—ï¼‰")
    heirs = st.text_input("ç°¡è¿°ï¼ˆä¾‹ï¼šé…å¶ 50%ã€äºŒå­å¥³å„ 25%ï¼‰", value="é…å¶ 50%ã€äºŒå­å¥³å„ 25%")

    submitted = st.form_submit_button("âš™ï¸ ç”¢ç”Ÿæ¨¡æ“¬çµæœ")

if not submitted:
    st.info("è«‹å®Œæˆä¸Šæ–¹ 3 å€‹æ­¥é©Ÿå¾Œï¼ŒæŒ‰ä¸‹ã€Œâš™ï¸ ç”¢ç”Ÿæ¨¡æ“¬çµæœã€ã€‚")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ¨¡æ“¬è¨ˆç®—ï¼ˆæ­£å¼ï¼š2025 éºç”¢ç¨…ä¸‰ç´šè·ï¼‹æ‰£é™¤ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
total_10k = int(realty + equities + cash)
if total_10k <= 0:
    st.error("è³‡ç”¢ç¸½é¡éœ€å¤§æ–¼ 0ã€‚")
    st.stop()

taxable_10k, base_tax_10k, deduct_10k = calculate_estate_tax_2025(
    total_10k,
    has_spouse=has_spouse,
    adult_children=int(adult_children),
    parents=int(parents),
    disabled_people=int(disabled_people),
    other_dependents=int(other_dependents),
)

# ä¸‰æƒ…å¢ƒï¼ˆå…ˆç”¨æ•ˆæœä¿‚æ•¸è¡¨é”æ–¹å‘ï¼›å¾ŒçºŒå¯é€æ­¥æ›¿æ›ç‚ºç²¾ç®—ï¼‰
def simulate_scenarios(prefer: str, overseas: str, base_tax_10k: int) -> Dict[str, Dict[str, Any]]:
    save_policy = 0.55
    save_trust  = 0.48
    if prefer == "ç¯€ç¨…å„ªå…ˆ":
        save_policy += 0.03; save_trust += 0.02
    elif prefer == "é™ä½å®¶æ—çˆ­è­°":
        save_trust  += 0.03
    if overseas != "ç„¡":
        save_trust  += 0.03

    policy_tax = max(int(round(base_tax_10k * (1 - save_policy))), 0)
    trust_tax  = max(int(round(base_tax_10k * (1 - save_trust))),  0)

    return {
        "ä¸è¦åŠƒï¼ˆåŸºæº–ï¼‰": {"total_tax": base_tax_10k, "note": "ä¾æ³•èª²ç¨…ï¼ˆ2025 æ­£å¼ç´šè·ï¼Œå«å…ç¨…èˆ‡æ‰£é™¤ï¼‰ã€‚"},
        "ä¿å–®è¦åŠƒ":       {"total_tax": policy_tax,   "note": "ä»¥ä¿å–®ç¾é‡‘åƒ¹å€¼é ç•™ç¨…æºæ± ã€æå‡æµå‹•æ€§ï¼ˆç¤ºæ„ï¼‰ã€‚"},
        "ä¿¡è¨—è¦åŠƒ":       {"total_tax": trust_tax,    "note": "ä¿¡è¨—æ¢æ¬¾å¯ç´æ•™è‚²/æ…ˆå–„èˆ‡è·¨å¢ƒåˆè¦ï¼ˆç¤ºæ„ï¼‰ã€‚"},
    }

comparisons = simulate_scenarios(prefer, overseas, base_tax_10k)
best_key, saved_10k, base_tax_show_10k, pct = derive_kpi(comparisons)
gap_10k, gap_note = liquidity_gap(base_tax_show_10k, int(cash))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é¡¯ç¤ºçµæœï¼ˆKPI + åœ–è¡¨ + è¨ˆç®—åŸºç¤ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.success("âœ… æ¨¡æ“¬å®Œæˆï¼šä»¥ä¸‹æ˜¯æ‚¨çš„å·®è·èˆ‡å»ºè­°")

k1, k2, k3, k4 = st.columns(4)
with k1:
    st.metric("æœ€ä½³æ–¹æ¡ˆï¼ˆç¤ºæ„ï¼‰", best_key)
with k2:
    st.metric("åŸºæº–ç¨…é¡", f"{base_tax_show_10k} è¬")
with k3:
    st.metric("é ä¼°å¯ç¯€çœ", f"{saved_10k} è¬", pct)
with k4:
    st.metric("ç¾é‡‘ç¨…æºç¼ºå£", f"{gap_10k} è¬")

df = pd.DataFrame(
    {"æƒ…å¢ƒ": list(comparisons.keys()),
     "ç¨…è²»åˆè¨ˆ_è¬å…ƒ": [v["total_tax"] for v in comparisons.values()]}
)
st.bar_chart(df, x="æƒ…å¢ƒ", y="ç¨…è²»åˆè¨ˆ_è¬å…ƒ", use_container_width=True)

with st.expander("ğŸ§¾ è¨ˆç®—åŸºç¤ï¼ˆå…ç¨…èˆ‡æ‰£é™¤ï¼‰", expanded=False):
    st.write(
        f"- èª²ç¨…éºç”¢æ·¨é¡ï¼š{taxable_10k} è¬\n"
        f"- ç¸½æ‰£é™¤é¡ï¼š{deduct_10k} è¬ï¼ˆå«å…ç¨… 1333 è¬ã€å–ªè‘¬ 138 è¬ã€é…å¶/å­å¥³/çˆ¶æ¯/èº«éšœ/å…¶ä»–å—æ‰¶é¤Šç­‰ï¼‰"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å ±å‘Šä¸‹è¼‰ï¼ˆEmail ç•™å­˜ â†’ PDFï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inputs_summary = {
    "å®¶åº­æˆå“¡": "ã€".join(members) if members else "ï¼ˆæœªå¡«ï¼‰",
    "è³‡ç”¢é…ç½®": f"ä¸å‹•ç”¢ {realty}ã€è‚¡ç¥¨ {equities}ã€ç¾é‡‘ {cash}ï¼ˆè¬å…ƒï¼‰",
    "æµ·å¤–è³‡ç”¢": overseas,
    "åå¥½": prefer,
    "åˆ†é…æ„å‘": sanitize_plus(heirs),
    "æ‰£é™¤æ‘˜è¦": f"é…å¶:{'æœ‰' if has_spouse else 'ç„¡'}ã€æˆå­å¥³:{int(adult_children)}ã€çˆ¶æ¯:{int(parents)}ã€"
               f"èº«éšœ:{int(disabled_people)}ã€å…¶ä»–å—æ‰¶é¤Š:{int(other_dependents)}",
}
result_summary = {
    "æœ€ä½³æ–¹æ¡ˆï¼ˆç¤ºæ„ï¼‰": best_key,
    "åŸºæº–ç¨…é¡": f"{base_tax_show_10k} è¬",
    "é ä¼°å¯ç¯€çœ": f"{saved_10k} è¬ï¼ˆ{pct}ï¼‰",
    "ç¾é‡‘ç¨…æºæª¢è¦–": gap_note,
}
recommendations = {
    "çŸ­æœŸ": "å…ˆå»ºç«‹å¯æ”¯ç”¨ä¹‹ç¨…æºæ± ï¼ˆå¦‚ï¼šå…·æœ‰ç¾é‡‘åƒ¹å€¼ä¹‹ä¿å–®ï¼‰ï¼Œé¿å…è‡¨æ™‚è™•åˆ†æ ¸å¿ƒè³‡ç”¢ï¼ˆç¤ºæ„ï¼‰ã€‚",
    "ä¸­æœŸ": "å°å…¥å®¶æ—ä¿¡è¨—ï¼ˆå«æ•™è‚²/å‰µæ¥­/æ…ˆå–„æ¢æ¬¾ï¼‰ï¼Œæå‡æ²»ç†èˆ‡è·¨å¢ƒåˆè¦ï¼ˆç¤ºæ„ï¼‰ã€‚",
    "é•·æœŸ": "åˆ¶å®šå®¶æ—æ†²ç« èˆ‡è‘£äº‹æœƒåˆ¶åº¦ï¼Œçµåˆè‚¡æ¬Šå®‰æ’ç¶­æŒæ§åˆ¶èˆ‡å…¬å¹³ï¼ˆç¤ºæ„ï¼‰ã€‚",
}

pdf_comparisons = {k: {"total_tax": int(v["total_tax"]), "note": v.get("note", "")} for k, v in comparisons.items()}

st.markdown("---")
st.subheader("ğŸ“„ ä¸‹è¼‰æ‚¨çš„é¡§å•ç´šå ±å‘Šï¼ˆå…è²»ï¼‰")
lead_capture_and_pdf(
    inputs_summary=inputs_summary,
    result_summary=result_summary,
    comparisons=pdf_comparisons,
    recommendations=recommendations,
    tag="path_sim_v2",
)
